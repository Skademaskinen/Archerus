name: Test NixOS configuration

on: push

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: prepare
        run: sudo apt install nix
      - name: start
        run: sudo systemctl start nix-daemon
      - name: build
        run: sudo nix --extra-experimental-features "nix-command flakes" build -f ./packages/backend.nix
  test-putricide:
    runs-on: ubuntu-latest
    steps:
      - name: prepare
        run: sudo apt install nix
      - name: start
        run: sudo systemctl start nix-daemon
      - name: build
        run: sudo nix --extra-experimental-features "nix-command flakes" build -f ./packages/putricide.nix
  test-skademaskinen:
    runs-on: ubuntu-latest
    steps:
      - name: prepare
        run: sudo apt install nix
      - name: start
        run: sudo systemctl start nix-daemon
      - name: nixos-rebuild
        run: sudo nix --extra-experimental-features "nix-command flakes" shell nixpkgs#nixos-rebuild --command "nixos-rebuild build-vm .#Skademaskinen"
  test-laptop:
    runs-on: ubuntu-latest
    steps:
      - name: prepare
        run: sudo apt install nix
      - name: start
        run: sudo systemctl start nix-daemon
      - name: nixos-rebuild
        run: sudo nix --extra-experimental-features "nix-command flakes" shell nixpkgs#nixos-rebuild --command "nixos-rebuild build-vm .#laptop"
  test-desktop:
    runs-on: ubuntu-latest
    steps:
      - name: prepare
        run: sudo apt install nix
      - name: start
        run: sudo systemctl start nix-daemon
      - name: nixos-rebuild
        run: sudo nix --extra-experimental-features "nix-command flakes" shell nixpkgs#nixos-rebuild --command "nixos-rebuild build-vm .#desktop"
